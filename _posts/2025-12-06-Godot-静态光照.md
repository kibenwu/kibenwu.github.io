---
layout: post
title: 'Godot-静态光照'
subtitle: Thinking in React vs. Thinking in Vue
author: kivenWu
header-style: text
tags:
  - Godot
  - TA
  - 
---
# 如何为场景打光
![](/uploads/to00.jpg)

我最近在试用 Godot 的光照贴图器（Lightmapper），并制作了一些简单的场景：

<img src="/uploads/to01.jpg" width="48%"> <img src="/uploads/to02.jpg" width="48%">

有些人问我是如何进行打光的。

我的做法是：添加一个 LightmapGI 节点，然后点击 Bake（烘焙）！

## 为什么要使用光照贴图？

自从电子游戏诞生以来，光照贴图就一直存在，而且看起来短期内也不会消失。

Lumen 非常棒！但它同样也非常昂贵，硬件光线追踪也是如此。你可以在桌面电脑上插上一张 RTX 显卡，享受实时全局光照，但你无法把它塞进像独立式 XR 头显这样的小设备里。它需要大量电力，而且会产生高热。我曾经在床上用一台 Zephyrus G15 笔记本打游戏（真正的玩家都会这么干），结果它在我腿上留下了真正的烫伤痕迹，好几周都没愈合！所谓的“游戏笔记本”其实并不算真正的笔记本，更像是一台桌面设备。你大概也不希望把这种东西戴在脸上。

Godot 自带的实时 GI（SDFGI / HDDAGI）以及半实时 GI（VoxelGI）都属于低频光照方案，并且在室内场景中容易出现漏光问题。HDDAGI 将来或许会适合用于超大规模的室外场景，但目前 Godot 本身还没有为这种规模的场景做好准备。

因此，在关卡几何体是静态的情况下，光照贴图依然是我们目前最好的选择。你可以在移动端、网页端，甚至在你奶奶的老式计算器上使用它们。它们成本低，而且效果不错。你还可以将光照贴图与直射光和 SSGI 混合使用，以缓解它们那种……“静态”的感觉。


## 室内场景

我在 Blender 里快速做了一个简单的室内场景  
[点击下载模型（GLTF）](/uploads/interior_scene.zip)：

![](/uploads/to03.jpg)

为了让导入的 glTF 能够进行光照贴图烘焙，你需要在 **Import（导入）面板** 中，将 **Light Baking** 设置为 **Static Lightmaps**。

![](/uploads/to04.jpg)

当我们添加一个 LightmapGI 节点并点击 Bake（烘焙）之后，就会看到这样的结果：

![](/uploads/to05.jpg)

在一些边缘附近会出现难看的光照条纹，这是因为光照贴图的分辨率太低了。

解决这个问题有两种方式：

- 使用 downsampling PR，在不提高最终光照贴图分辨率的情况下，提高光照贴图的渲染分辨率；或者等待这个 PR 被合并进引擎核心。
- 直接提高光照贴图的分辨率。

反正我们本来就打算提高分辨率，所以这里选择方案 2。将 **texel scale** 设置为 2，就可以让这些条纹消失：

![](/uploads/to06.jpg)

如果我们将 **texel scale** 设为 8，**bounces** 设为 10，**denoiser strength** 设为 0.2，**quality** 设为 Ultra，就可以得到一个相当不错的结果：

![](/uploads/to07.jpg)

你需要使用多高的 texel scale，完全取决于你的游戏。有些几何体可能需要更高或更低分辨率的光照贴图，这取决于它们距离相机有多远，或者它们在画面中是否足够重要。Godot 4.4 现在已经支持为每个对象单独设置精确的光照贴图缩放。

如果我们改变自发光表面的颜色和强度，添加几个雾体积（Fog Volume），并开启 Bloom（泛光），场景就可以显得更有戏剧感：

![](/uploads/to08.jpg)

![](/uploads/to09.jpg)

我说过吧，其实并没有多复杂！

请记住，**反照率（Albedo）会影响间接光照**！如果你把材质调得太暗，得到的间接光照就会变少！而纯黑色材质是完全不会反射任何光的。



### 室外场景

我们用这个简单的 glTF 来做室外光照实验：  
[点击下载模型（GLTF）](/uploads/scene-outdoors.zip)：

![](/uploads/to10.jpg)

在 Godot 中，如果你在顶部工具栏里启用了 **预览太阳光和环境光**，场景看起来会是这样：

![](/uploads/to11.jpg)

我们也可以通过顶部工具栏，直接把预览用的环境光和太阳光添加到场景中，这样就不需要从零开始手动创建这些节点了。

为了让太阳阴影更精确一些，我们可以在 **DirectionalLight3D** 节点设置中降低 **Shadow Bias**，并在项目设置中提高直射光的分辨率  
（`rendering/lights_and_shadows/directional_shadow/size`）。

<img src="/uploads/to12.jpg" width="48%"> <img src="/uploads/to13.jpg" width="48%">

虽然它并不完美，但在远距离观察时你基本不会注意到这些问题。

如果我们使用默认设置来烘焙光照贴图，结果会是这样：

![](/uploads/to14.jpg)

由于分辨率太低，看起来效果很差。将 **texel density** 设置为 12 之后，效果会变成这样：

![](/uploads/to15.jpg)

不过你马上就会注意到一个非常灾难性的问题：当两个不同的网格彼此接触时，会出现严重的阴影泄漏（比如右侧墙体与地面、以及与后墙的接触处）。

这其实就是 Godot 光照贴图器在网格彼此接触时会发生的情况：

![](/uploads/to16.jpg)

为了解决这个问题，我会修改场景结构，让这些网格不再直接接触，就像这样（附带的 glTF 文件已经包含了这个修复）：

![](/uploads/to17.jpg)

需要注意的是，**仅仅移除墙体底部的面并不能解决问题**，因为阴影仍然可以在那里生成，并且会向外泄漏。这感觉是一个比较大的限制，因为它让基于模块化块来搭建场景变得更困难。希望将来能在引擎层面解决这个问题  
（更新：我已经在引擎中修复了这个问题，所以你现在不需要再担心这个 bug 了）。

不过在做了这些调整之后，阴影泄漏问题就消失了：

![](/uploads/to18.jpg)

接下来我们还可以进一步优化一些地方。首先，我们需要决定想要什么样的天气效果。我打算做一个**晴朗、无云的白天场景**。

为了让它看起来像晴天，我们可以提高太阳光的 **Energy**，因为你也知道，晴天里的太阳亮得离谱。我会把它设为 2.0，同时把 **Indirect Energy** 设为 3.0，这样可以让室内区域看起来不会太暗。

另一个晴天中非常明显的特征是：天空通常是蓝色的，而默认的预览天空并不是。为了解决这个问题，我们需要在 **Environment** 节点中，把天空材质从 **ProceduralSkyMaterial** 改为 **PhysicalSkyMaterial**，并调整 **Rayleigh** 的颜色，让它更加饱和。天空不仅影响天空盒，还会影响实时与烘焙的环境光，因此蓝色天空会让阴影带上一点蓝色——这在现实世界中也是如此！

直射阳光的色温是 4800K，理论上属于白光，但在这个家里我们不讲事实、逻辑和理性，所以我决定把它调成偏黄色的 `#fffce8`，让它与蓝色天空形成互补，同时给画面带来一种温暖、梦幻的感觉。

在完成这些调整，并稍微改变太阳角度之后，画面会变成这样：

![](/uploads/to19.jpg)

再稍微加一点 Bloom 和 SSAO，效果如下：

![](/uploads/to20.jpg)

<img src="/uploads/to21.jpg" width="48%"> <img src="/uploads/to22.jpg" width="48%">

仅凭一个 blockout 级别的几何结构，我们能做到的也就到这里了。如果使用更精细的几何体，画面效果会好得多。表面材质会对光照的观感产生非常大的影响，同时也会影响光照的行为方式。正如前面提到的，材质会影响反弹光照，因此在添加材质之后，你可能还需要重新微调灯光参数。

请记住，在 Godot 的输入框里并不存在什么“正确”的数值可以直接让光照变得好看。这些参数会根据你在制作什么样的游戏而发生变化——天气、氛围、整体风格都会影响最终结果。正因为如此，这些东西才都是可配置的。

在这个示例中，我们最终得到的是一个晴朗的白天场景，光照强烈到近乎压迫，甚至带着一点超现实感，让人感觉时间仿佛停滞了。

至少，我个人是这么感觉的。
